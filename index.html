import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  addDoc, 
  serverTimestamp,
  deleteDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  PlusCircle, 
  Trash2, 
  TrendingUp, 
  TrendingDown, 
  Wallet, 
  RefreshCw,
  AlertCircle,
  CheckCircle2,
  Terminal
} from 'lucide-react';

// --- INICIALIZACIÓN SEGURA ---
const getFirebaseConfig = () => {
  try {
    return JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  } catch (e) {
    return {};
  }
};

const firebaseConfig = getFirebaseConfig();
const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-app';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [logs, setLogs] = useState([]);

  // Formulario
  const [desc, setDesc] = useState('');
  const [amount, setAmount] = useState('');
  const [type, setType] = useState('income');

  const addLog = (msg) => setLogs(prev => [msg, ...prev].slice(0, 5));

  // 1. Autenticación (Regra 3)
  useEffect(() => {
    const initAuth = async () => {
      addLog("Iniciando autenticación...");
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
        addLog("Autenticación exitosa.");
      } catch (err) {
        addLog("Error de Auth: " + err.message);
        setError("Error de conexión segura: " + err.message);
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // 2. Sincronización (Regras 1 y 2)
  useEffect(() => {
    if (!user) return;

    addLog("Conectando a base de datos...");
    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounting');
    
    const unsubscribe = onSnapshot(
      colRef,
      (snapshot) => {
        addLog(`Datos recibidos: ${snapshot.size} registros.`);
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const sorted = data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        setTransactions(sorted);
        setError(null);
      },
      (err) => {
        addLog("Error Firestore: " + err.message);
        setError("Error de sincronización: " + err.message);
      }
    );

    return () => unsubscribe();
  }, [user]);

  const totals = useMemo(() => {
    return transactions.reduce((acc, curr) => {
      const val = parseFloat(curr.amount) || 0;
      if (curr.type === 'income') acc.income += val;
      else acc.expense += val;
      acc.balance = acc.income - acc.expense;
      return acc;
    }, { income: 0, expense: 0, balance: 0 });
  }, [transactions]);

  const handleAdd = async (e) => {
    e.preventDefault();
    if (!desc || !amount || !user) return;

    try {
      const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounting');
      await addDoc(colRef, {
        description: desc,
        amount: parseFloat(amount),
        type,
        userId: user.uid,
        createdAt: serverTimestamp()
      });
      setDesc(''); setAmount('');
    } catch (err) {
      addLog("Error al guardar: " + err.message);
      setError("No se pudo registrar la operación.");
    }
  };

  if (loading && !error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-white">
        <RefreshCw className="animate-spin text-blue-500 mb-4" size={32} />
        <p className="text-slate-500 font-medium">Estableciendo conexión...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* Top Bar */}
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-bold flex items-center gap-2 text-slate-800">
            <Wallet className="text-blue-600" /> Libro Contable
          </h1>
          <div className={`text-xs px-3 py-1 rounded-full flex items-center gap-2 ${user ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
            <div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500' : 'bg-amber-500 animate-pulse'}`} />
            {user ? 'Conectado' : 'Conectando...'}
          </div>
        </div>

        {/* Totals */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card title="Ingresos" value={totals.income} color="text-green-600" icon={<TrendingUp size={16}/>} />
          <Card title="Gastos" value={totals.expense} color="text-red-600" icon={<TrendingDown size={16}/>} />
          <Card title="Balance" value={totals.balance} color="text-blue-600" bg="bg-blue-50 border-blue-100" icon={<Wallet size={16}/>} />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Form */}
          <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm h-fit">
            <h2 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wider text-slate-500">
              <PlusCircle size={16} /> Nuevo Registro
            </h2>
            <form onSubmit={handleAdd} className="space-y-4">
              <Input label="Concepto" value={desc} onChange={setDesc} placeholder="Ej. Venta" />
              <Input label="Monto" type="number" value={amount} onChange={setAmount} placeholder="0.00" />
              <div className="flex gap-2">
                <TypeBtn active={type === 'income'} onClick={() => setType('income')} label="Ingreso" color="bg-green-500" />
                <TypeBtn active={type === 'expense'} onClick={() => setType('expense')} label="Gasto" color="bg-red-500" />
              </div>
              <button type="submit" className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition-all">Guardar</button>
            </form>
          </div>

          {/* List */}
          <div className="lg:col-span-2 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div className="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
              <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Historial</span>
              <span className="text-[10px] text-slate-400 font-mono">ID: {user?.uid.slice(0,8)}</span>
            </div>
            <div className="max-h-[400px] overflow-y-auto">
              {transactions.length === 0 ? (
                <div className="p-12 text-center text-slate-400 text-sm italic">No hay datos sincronizados</div>
              ) : (
                <table className="w-full">
                  <tbody className="divide-y divide-slate-100">
                    {transactions.map(t => (
                      <tr key={t.id} className="hover:bg-slate-50/50">
                        <td className="px-6 py-4">
                          <p className="text-sm font-medium">{t.description}</p>
                          <p className="text-[10px] text-slate-400">{t.createdAt ? new Date(t.createdAt.seconds * 1000).toLocaleTimeString() : '...'}</p>
                        </td>
                        <td className={`px-6 py-4 text-sm font-bold text-right ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>
                          {t.type === 'income' ? '+' : '-'}${t.amount.toLocaleString()}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        </div>

        {/* Debug Logs Panel */}
        <div className="bg-slate-900 rounded-xl p-4 text-white font-mono text-[10px] opacity-80">
          <div className="flex items-center gap-2 mb-2 text-slate-400 border-b border-slate-800 pb-2">
            <Terminal size={12} /> SISTEMA DE DIAGNÓSTICO
          </div>
          {logs.map((log, i) => <div key={i} className="mb-1 leading-tight">{`> ${log}`}</div>)}
          {error && <div className="text-red-400 mt-2 font-bold">{`!! ERROR: ${error}`}</div>}
        </div>

      </div>
    </div>
  );
}

// Sub-componentes
const Card = ({ title, value, color, icon, bg="bg-white" }) => (
  <div className={`${bg} p-5 rounded-2xl border border-slate-200 shadow-sm`}>
    <div className="flex items-center gap-2 text-slate-400 mb-1 font-bold text-[10px] uppercase tracking-wider">{icon} {title}</div>
    <div className={`text-xl font-black ${color}`}>${(value || 0).toLocaleString()}</div>
  </div>
);

const Input = ({ label, value, onChange, ...p }) => (
  <div>
    <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{label}</label>
    <input {...p} value={value} onChange={e => onChange(e.target.value)} className="w-full px-4 py-2 rounded-xl border border-slate-100 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm" />
  </div>
);

const TypeBtn = ({ active, onClick, label, color }) => (
  <button type="button" onClick={onClick} className={`flex-1 py-2 rounded-xl text-[10px] font-bold transition-all ${active ? `${color} text-white` : 'bg-slate-100 text-slate-500'}`}>{label}</button>
);