<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiContabilidad - Cloud & Local Hybrid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .nav-item.active { background-color: #eff6ff; color: #2563eb; border-right: 4px solid #2563eb; }
        #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .preview-container img { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex">

    <!-- Pantalla de Carga -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="text-gray-500 font-medium">Conectando sistema...</p>
    </div>

    <!-- Sidebar -->
    <aside class="bg-white w-64 hidden md:flex flex-col shadow-xl z-10">
        <div class="p-6 border-b flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fa-solid fa-wallet text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-900 leading-none">MiConta</h1>
                <p id="storage-mode-label" class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">Detectando Modo...</p>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="switchView('dashboard-total')" id="nav-dashboard-total" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-lg">
                <i class="fa-solid fa-chart-line w-5"></i> Global
            </button>
            <button onclick="switchView('dashboard-monthly')" id="nav-dashboard-monthly" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-lg">
                <i class="fa-solid fa-calendar-days w-5"></i> Mensual
            </button>
            <button onclick="switchView('transactions')" id="nav-transactions" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-lg">
                <i class="fa-solid fa-list-ul w-5"></i> Movimientos
            </button>
            <button onclick="switchView('invoices')" id="nav-invoices" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-lg">
                <i class="fa-solid fa-file-invoice w-5"></i> Facturas
            </button>
        </nav>
        <div class="p-4 border-t bg-gray-50">
            <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">Usuario / ID</p>
            <code id="user-display-id" class="text-[9px] block bg-white p-2 rounded border border-gray-200 text-blue-500 font-mono break-all italic">local_user</code>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-20">
            <h2 id="header-ctx" class="font-bold text-gray-700 uppercase text-xs tracking-wider">Dashboard Global</h2>
            <div class="flex items-center gap-3">
                <div id="sync-icon" class="hidden text-green-500 text-[10px] font-bold uppercase flex items-center gap-1">
                    <i class="fa-solid fa-cloud-check text-sm"></i> Sincronizado
                </div>
                <button onclick="openModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-blue-700 transition">
                    + Nuevo Registro
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6" id="main-content">
            <!-- VISTA GLOBAL -->
            <div id="view-dashboard-total" class="fade-in space-y-6">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ingresos</p>
                        <p class="text-xl font-bold text-gray-900 mt-1" id="g-inc">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Gastos</p>
                        <p class="text-xl font-bold text-gray-900 mt-1" id="g-exp">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">Balance</p>
                        <p class="text-xl font-bold text-blue-600 mt-1" id="g-bal">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">IVA (13%)</p>
                        <p class="text-xl font-bold text-purple-600 mt-1" id="g-iva">$0.00</p>
                    </div>
                    <div class="bg-blue-600 p-4 rounded-xl shadow-md text-white border border-blue-500">
                        <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Renta (2%)</p>
                        <p class="text-xl font-bold mt-1" id="g-ren">$0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-2 min-h-[300px]">
                        <canvas id="globalChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-blue-500"></i> Recientes</h3>
                        <div id="recent-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- VISTA MENSUAL -->
            <div id="view-dashboard-monthly" class="hidden fade-in space-y-6">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-700 uppercase text-xs tracking-widest">Análisis por Periodo</h3>
                    <input type="month" id="month-selector" onchange="renderAll()" class="border px-3 py-1 rounded-lg font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4" id="monthly-stats-container">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Ingresos Mes</p>
                        <p class="text-xl font-bold text-gray-900" id="m-inc">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Gastos Mes</p>
                        <p class="text-xl font-bold text-gray-900" id="m-exp">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-blue-500 uppercase">Balance Mes</p>
                        <p class="text-xl font-bold text-blue-600" id="m-bal">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-bold text-purple-400 uppercase">IVA Mes</p>
                        <p class="text-xl font-bold text-purple-600" id="m-iva">$0.00</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Renta Mes</p>
                        <p class="text-xl font-bold text-blue-700" id="m-ren">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- VISTA TABLA -->
            <div id="view-transactions" class="hidden fade-in">
                <div class="bg-white rounded-2xl shadow-sm overflow-x-auto border border-gray-100">
                    <table class="w-full text-left text-xs min-w-[1000px]">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase tracking-tighter">
                            <tr>
                                <th class="px-4 py-4">Fecha</th>
                                <th class="px-4 py-4">Descripción</th>
                                <th class="px-4 py-4 text-right">Monto</th>
                                <th class="px-4 py-4 text-right text-gray-400 italic">IVA (13%)</th>
                                <th class="px-4 py-4 text-right text-gray-400 italic">Renta (2%)</th>
                                <th class="px-4 py-4 text-right font-bold">Neto</th>
                                <th class="px-4 py-4 text-center">Factura</th>
                                <th class="px-4 py-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tx-table" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISTA FACTURAS -->
            <div id="view-invoices" class="hidden fade-in">
                <div id="invoice-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
        </main>
    </div>

    <!-- MODAL DE REGISTRO -->
    <div id="tx-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-gray-800 mb-6" id="m-title">Nueva Operación</h3>
            <form id="tx-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button type="button" onclick="setType('income')" id="btn-inc" class="flex-1 py-2 rounded-lg font-bold text-xs bg-white text-green-600 shadow-sm transition-all">INGRESO</button>
                    <button type="button" onclick="setType('expense')" id="btn-exp" class="flex-1 py-2 rounded-lg font-bold text-xs text-gray-500 transition-all">GASTO</button>
                    <input type="hidden" id="f-type" value="income">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Monto ($)</label>
                        <input type="number" step="0.01" id="f-amount" placeholder="0.00" class="w-full border p-2.5 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Fecha</label>
                        <input type="date" id="f-date" class="w-full border p-2.5 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Descripción</label>
                    <input type="text" id="f-desc" placeholder="Nombre del movimiento" class="w-full border p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Categoría</label>
                    <select id="f-cat" class="w-full border p-2.5 rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <option>Ventas</option><option>Servicios</option><option>Suministros</option><option>Alquiler</option><option>Otros</option>
                    </select>
                </div>
                <div class="border-t pt-4">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Adjuntar Comprobante</label>
                    <label class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-100 transition group">
                        <i class="fa-solid fa-camera text-gray-400 group-hover:text-blue-500"></i>
                        <span id="file-label" class="text-xs font-bold text-gray-600">Elegir o Tomar Foto</span>
                        <input type="file" id="f-file" class="hidden" accept="image/*,.pdf" capture="environment">
                    </label>
                    <p id="file-status" class="text-[9px] text-gray-400 mt-1 text-center italic"></p>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Cerrar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VISOR DE ARCHIVOS -->
    <div id="viewer-modal" class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-eye text-blue-600"></i> Visor de Comprobante</h3>
                <button onclick="closeViewer()" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-circle-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-4 flex items-center justify-center bg-gray-900" id="viewer-content">
                <!-- Se inyecta la imagen real aquí -->
            </div>
            <div class="p-4 bg-white border-t flex justify-between items-center">
                <div class="overflow-hidden">
                    <p id="view-name" class="text-sm font-bold text-gray-800 truncate"></p>
                    <p id="view-date" class="text-[10px] text-gray-400"></p>
                </div>
                <button onclick="closeViewer()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 shadow-md">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS CORE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración y Detección de Entorno ---
        let db = null, auth = null, appId = 'local-app';
        let cloudEnabled = false;
        let transactions = JSON.parse(localStorage.getItem('my_conta_data')) || [];
        let invoices = JSON.parse(localStorage.getItem('my_conta_invs')) || [];

        // Intentar conectar a la nube si hay configuración disponible (Chat Preview)
        try {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
                cloudEnabled = true;
                
                document.getElementById('storage-mode-label').textContent = "Modo Nube Activo";
                document.getElementById('storage-mode-label').classList.replace('text-gray-400', 'text-green-600');
            } else {
                document.getElementById('storage-mode-label').textContent = "Modo Local (GitHub)";
            }
        } catch (e) {
            console.log("Funcionando en modo local.");
        }

        const format = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
        let globalChart = null;

        // --- Lógica de Inicio ---
        window.onload = async () => {
            if (cloudEnabled) {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        document.getElementById('user-display-id').textContent = user.uid;
                        setupCloudListeners(user.uid);
                    }
                });
            } else {
                // Modo Local: Simular carga
                setTimeout(hideLoader, 1000);
            }
            
            document.getElementById('f-date').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('month-selector').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            renderAll();
        };

        function hideLoader() {
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
        }

        // --- Escuchadores Nube ---
        function setupCloudListeners(uid) {
            const txCol = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
            onSnapshot(txCol, (snap) => {
                transactions = snap.docs.map(d => d.data());
                renderAll();
                hideLoader();
                showSync();
            });

            const invCol = collection(db, 'artifacts', appId, 'users', uid, 'invoices');
            onSnapshot(invCol, (snap) => {
                invoices = snap.docs.map(d => d.data());
                renderAll();
                showSync();
            });
        }

        function showSync() {
            const icon = document.getElementById('sync-icon');
            icon.classList.remove('hidden');
            setTimeout(() => icon.classList.add('hidden'), 2000);
        }

        // --- Renderizado y UI ---
        window.renderAll = () => {
            if (!cloudEnabled) {
                localStorage.setItem('my_conta_data', JSON.stringify(transactions));
                localStorage.setItem('my_conta_invs', JSON.stringify(invoices));
            }
            renderDashboards();
            renderTable();
            renderInvoiceGrid();
        };

        function renderDashboards() {
            // Global
            let inc = 0, exp = 0;
            transactions.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);
            const bal = inc - exp;
            document.getElementById('g-inc').innerText = format(inc);
            document.getElementById('g-exp').innerText = format(exp);
            document.getElementById('g-bal').innerText = format(bal);
            document.getElementById('g-iva').innerText = format(bal > 0 ? bal * 0.13 : 0);
            document.getElementById('g-ren').innerText = format(inc * 0.02);

            // Chart
            const ctx = document.getElementById('globalChart').getContext('2d');
            if(globalChart) globalChart.destroy();
            globalChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Balance Global'], datasets: [{label:'Ingresos', data:[inc], backgroundColor:'#22c55e', borderRadius:8},{label:'Gastos', data:[exp], backgroundColor:'#ef4444', borderRadius:8}]},
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Recent
            const list = document.getElementById('recent-list');
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            list.innerHTML = recent.map(t => `
                <div class="flex justify-between p-3 bg-gray-50 rounded-xl border border-transparent shadow-sm">
                    <div>
                        <p class="font-bold text-gray-800 text-xs">${t.desc}</p>
                        <p class="text-[9px] text-gray-400 font-bold uppercase">${t.date}</p>
                    </div>
                    <span class="font-bold text-xs self-center ${t.type==='income'?'text-green-600':'text-red-600'}">${format(t.amount)}</span>
                </div>
            `).join('');

            // Mensual
            const picker = document.getElementById('month-selector').value;
            if (picker) {
                const [y, m] = picker.split('-').map(Number);
                const filtered = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getUTCFullYear() === y && (d.getUTCMonth() + 1) === m;
                });
                let mInc = 0, mExp = 0;
                filtered.forEach(t => t.type === 'income' ? mInc += t.amount : mExp += t.amount);
                const mBal = mInc - mExp;
                document.getElementById('m-inc').innerText = format(mInc);
                document.getElementById('m-exp').innerText = format(mExp);
                document.getElementById('m-bal').innerText = format(mBal);
                document.getElementById('m-iva').innerText = format(mBal > 0 ? mBal * 0.13 : 0);
                document.getElementById('m-ren').innerText = format(mInc * 0.02);
            }
        }

        function renderTable() {
            const body = document.getElementById('tx-table');
            const sorted = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            body.innerHTML = sorted.map(t => {
                const isInc = t.type === 'income';
                const iva = isInc ? t.amount * 0.13 : 0;
                const ren = isInc ? t.amount * 0.02 : 0;
                const net = isInc ? (t.amount - iva - ren) : -t.amount;
                const hasInv = invoices.some(i => i.txId === t.id);

                return `<tr class="hover:bg-gray-50 transition border-b border-gray-100">
                    <td class="px-4 py-4 whitespace-nowrap">${t.date}</td>
                    <td class="px-4 py-4 font-bold text-gray-700">${t.desc}</td>
                    <td class="px-4 py-4 text-right font-medium">${format(t.amount)}</td>
                    <td class="px-4 py-4 text-right text-gray-400 italic">${isInc?format(iva):'-'}</td>
                    <td class="px-4 py-4 text-right text-gray-400 italic">${isInc?format(ren):'-'}</td>
                    <td class="px-4 py-4 text-right font-bold ${isInc?'text-blue-600':'text-red-500'}">${format(net)}</td>
                    <td class="px-4 py-4 text-center">
                        ${hasInv ? `<button onclick="window.viewAttachment('${t.id}')" class="text-blue-500 hover:scale-125 transition" title="Ver Comprobante"><i class="fa-solid fa-paperclip text-lg"></i></button>` : `<i class="fa-solid fa-minus text-gray-200"></i>`}
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center gap-3">
                            <button onclick="window.app_edit('${t.id}')" class="text-blue-400 hover:text-blue-600 transition" title="Editar"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="window.app_del('${t.id}')" class="text-red-300 hover:text-red-500 transition" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderInvoiceGrid() {
            const grid = document.getElementById('invoice-grid');
            if (invoices.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-20 text-center text-gray-400 text-xs uppercase tracking-widest font-bold">Sin archivos registrados</div>';
                return;
            }
            grid.innerHTML = invoices.map(i => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-blue-300 transition group cursor-pointer" onclick="window.viewAttachment('${i.txId}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 text-blue-500 rounded-lg flex items-center justify-center shadow-inner"><i class="fa-solid fa-file-invoice text-lg"></i></div>
                        <div class="overflow-hidden flex-1">
                            <p class="text-xs font-bold text-gray-700 truncate">${i.name}</p>
                            <p class="text-[9px] text-gray-400 font-bold uppercase">${i.date}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Acciones de Formulario ---
        window.switchView = (v) => {
            ['dashboard-total', 'dashboard-monthly', 'transactions', 'invoices'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById(`nav-${v}`).classList.add('active');
            document.getElementById('header-ctx').innerText = v.split('-').join(' ').toUpperCase();
        };

        window.openModal = () => { 
            document.getElementById('tx-modal').classList.remove('hidden'); 
            document.getElementById('m-title').innerText = "Nueva Operación";
            document.getElementById('edit-id').value = "";
            document.getElementById('file-status').innerText = "";
        };

        window.closeModal = () => { 
            document.getElementById('tx-modal').classList.add('hidden'); 
            document.getElementById('tx-form').reset();
            setType('income');
        };

        window.setType = (t) => {
            document.getElementById('f-type').value = t;
            document.getElementById('btn-inc').className = t === 'income' ? 'flex-1 py-2 rounded-lg font-bold text-xs bg-white text-green-600 shadow-sm' : 'flex-1 py-2 text-gray-500 font-bold text-xs';
            document.getElementById('btn-exp').className = t === 'expense' ? 'flex-1 py-2 rounded-lg font-bold text-xs bg-white text-red-600 shadow-sm' : 'flex-1 py-2 text-gray-500 font-bold text-xs';
        };

        window.app_edit = (id) => {
            const t = transactions.find(x => x.id === id);
            if(!t) return;
            window.openModal();
            document.getElementById('m-title').innerText = "Editar Registro";
            document.getElementById('edit-id').value = t.id;
            document.getElementById('f-amount').value = t.amount;
            document.getElementById('f-date').value = t.date;
            document.getElementById('f-desc').value = t.desc;
            document.getElementById('f-cat').value = t.cat;
            setType(t.type);
            const inv = invoices.find(i => i.txId === id);
            if(inv) document.getElementById('file-status').innerText = "Factura actual: " + inv.name;
        };

        window.app_del = async (id) => {
            if(!confirm('¿Eliminar este registro?')) return;
            if (cloudEnabled && auth.currentUser) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'transactions', id));
                const inv = invoices.find(i => i.txId === id);
                if(inv) await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'invoices', inv.id));
            } else {
                transactions = transactions.filter(t => t.id !== id);
                invoices = invoices.filter(i => i.txId !== id);
                renderAll();
            }
        };

        window.viewAttachment = (txId) => {
            const inv = invoices.find(i => i.txId === txId);
            if(!inv) return;
            const content = document.getElementById('viewer-content');
            content.innerHTML = '';
            document.getElementById('view-name').innerText = inv.name;
            document.getElementById('view-date').innerText = "Registrado el: " + inv.date;
            
            if(inv.data) {
                const img = document.createElement('img');
                img.src = inv.data;
                img.className = "max-w-full max-h-full shadow-2xl rounded-lg";
                content.appendChild(img);
            } else {
                content.innerHTML = '<div class="text-white text-center"><i class="fa-solid fa-file-circle-exclamation text-4xl mb-2"></i><p>Este archivo no tiene datos visuales (creado antes de la actualización).</p></div>';
            }
            document.getElementById('viewer-modal').classList.remove('hidden');
        };

        window.closeViewer = () => document.getElementById('viewer-modal').classList.add('hidden');

        document.getElementById('f-file').addEventListener('change', (e) => {
            if(e.target.files[0]) document.getElementById('file-status').innerText = "Preparado: " + e.target.files[0].name;
        });

        document.getElementById('tx-form').onsubmit = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const id = editId || Date.now().toString();
            const tx = {
                id,
                type: document.getElementById('f-type').value,
                amount: parseFloat(document.getElementById('f-amount').value),
                date: document.getElementById('f-date').value,
                desc: document.getElementById('f-desc').value,
                cat: document.getElementById('f-cat').value
            };

            const file = document.getElementById('f-file').files[0];
            let invData = null;

            if (file) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    invData = { txId: id, name: file.name, date: new Date().toLocaleDateString(), data: ev.target.result };
                    await finalSave(tx, invData);
                };
                reader.readAsDataURL(file);
            } else {
                await finalSave(tx, null);
            }
        };

        async function finalSave(tx, inv) {
            if (cloudEnabled && auth.currentUser) {
                const txRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'transactions', tx.id);
                await setDoc(txRef, tx);
                if(inv) {
                    const invId = Date.now().toString();
                    const invRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'invoices', invId);
                    await setDoc(invRef, {...inv, id: invId});
                }
            } else {
                if(document.getElementById('edit-id').value) {
                    transactions = transactions.map(t => t.id === tx.id ? tx : t);
                    if(inv) invoices = invoices.map(i => i.txId === tx.id ? inv : i);
                } else {
                    transactions.push(tx);
                    if(inv) invoices.push(inv);
                }
                renderAll();
            }
            closeModal();
        }
    </script>
</body>
</html>